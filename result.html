<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>结果 · 饭圈粉丝人格测评</title>
  <meta name="theme-color" content="#ffffff"/>
  <style>body{font-family:system-ui,Inter,Arial;margin:0;background:#fff;color:#111}main{max-width:900px;margin:0 auto;padding:20px}a{color:#4f46e5;text-decoration:none}.card{border:1px solid rgba(17,24,39,.08);border-radius:14px;padding:14px;margin-top:12px}</style>
</head>
<body>
  <main>
    <h1 style="margin:8px 0">结果</h1>
    <div class="card">
      <div id="meta" style="color:#6b7280;font-size:12px">加载中…</div>
      <canvas id="c" width="900" height="1200" style="width:100%;border-radius:12px;border:1px solid rgba(17,24,39,.08);margin-top:10px"></canvas>
      <div style="margin-top:10px">
        <a id="dl" class="btn" href="#">下载分享图</a> · <a href="./index.html">返回首页</a>
      </div>
    </div>
  </main>
  <script>
    const usp = new URLSearchParams(location.search);
    let scores, idol;
    if(usp.get('demo')){
      scores = {effort:82,rational:74,social:68,lore:91};
      idol = '晨曦偶像·林X';
    }else{
      try{ scores = JSON.parse(atob(usp.get('scores')||'')); idol = usp.get('idol')||'我的爱豆'; }catch(e){ scores=null; }
    }
    const c=document.getElementById('c'), ctx=c.getContext('2d');
    function rr(ctx,x,y,w,h,r){ if (w<2*r) r=w/2; if (h<2*r) r=h/2; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
    function draw(){
      const W=c.width,H=c.height; ctx.clearRect(0,0,W,H);
      const g=ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,'#fff'); g.addColorStop(1,'#f5f7fb'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#111827'; ctx.font='bold 48px system-ui,Inter'; ctx.fillText('饭圈人格测评',48,96);
      const type = (()=>{ if(!scores) return '尚未测评'; const arr=Object.entries(scores).sort((a,b)=>b[1]-a[1]); const map={effort:'扩散派·应援长',rational:'理智派·资料官',social:'社交派·安利手',lore:'考据派·档案师'}; return map[arr[0][0]]; })();
      ctx.font='24px system-ui,Inter'; ctx.fillStyle='#6b7280'; ctx.fillText('粉籍类型：'+type,48,140);
      const idolName = idol||'我的爱豆';
      ctx.fillStyle='rgba(17,24,39,.06)'; rr(ctx,48,168,420,44,12); ctx.fill();
      ctx.fillStyle='#111827'; ctx.font='18px system-ui,Inter'; ctx.fillText('应援对象：'+idolName,64,196);
      const label=[['应援投入','effort'],['理智指数','rational'],['社交扩散','social'],['内容考据','lore']];
      let y=260; const barW=560, barH=18;
      label.forEach(([name,key])=>{
        const v=scores? (scores[key]||0):0;
        ctx.fillStyle='#6b7280'; ctx.font='18px system-ui,Inter'; ctx.fillText(name, 48, y);
        rr(ctx, 48, y+16, barW, barH, 9); ctx.strokeStyle='rgba(17,24,39,.12)'; ctx.stroke();
        ctx.fillStyle='#6366f1'; rr(ctx, 48, y+16, Math.max(0,Math.min(barW*v/100,barW)), barH, 9); ctx.fill();
        ctx.fillStyle='#111827'; ctx.font='bold 18px system-ui,Inter'; ctx.fillText(String(v), 48+barW+12, y+31);
        y+=72;
      });
      ctx.fillStyle='#6b7280'; ctx.font='16px system-ui,Inter'; ctx.fillText('科普/参考 · 非医疗诊断 · '+new Date().toLocaleDateString(), 48, H-64);
      ctx.fillStyle='#111827'; ctx.font='16px system-ui,Inter'; ctx.fillText(location.host, 48, H-36);
      document.getElementById('meta').textContent = '应援对象：'+(idolName)+' · '+(scores? '四维：'+Object.values(scores).join('/') : '尚未生成分数');
    }
    draw();
    document.getElementById('dl').onclick=(e)=>{ e.preventDefault(); const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='fan-profile.png'; a.click(); };
  </script>
</body>
</html>
