<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>饭圈粉丝人格测评 · 5分钟生成可分享结果卡</title>
  <meta name="description" content="面向饭圈粉丝与爱豆支持者的轻量测评，5分钟完成，生成可分享结果卡；可选择升级解锁完整PDF报告与7日练习清单。浅色主题。"/>
  <meta name="theme-color" content="#ffffff"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{--bg:#ffffff;--panel:#ffffff;--ink:#111827;--muted:#6b7280;--pri:#6366f1;--pri2:#22d3ee;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--border:rgba(17,24,39,.08);--share-bg1:#ffffff;--share-bg2:#f5f7fb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Helvetica,Arial}
    a{color:#4f46e5;text-decoration:none}
    .container{max-width:1060px;margin:0 auto;padding:20px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px}
    .btn{background:linear-gradient(90deg,var(--pri),var(--pri2));color:#fff;padding:12px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:600}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--ink);font-size:12px}
    .muted{color:var(--muted)}
    .kv{display:grid;gap:14px;grid-template-columns:2fr 1fr}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    h1{font-size:32px;margin:0 0 8px}
    h2{font-size:22px;margin:0 0 8px}
    .num{width:28px;height:28px;border-radius:999px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;margin-right:8px;color:var(--pri)}
    .footer{color:var(--muted);font-size:12px;margin-top:26px}
    .bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--pri),var(--pri2))}
    .pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;cursor:pointer}
    .pill.active{background:rgba(99,102,241,.12);border-color:#7c6cff}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .nav a{margin-left:12px}
    .sticky{position:sticky;top:12px}
    .hidden{display:none !important}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .price-tag{font-size:26px;font-weight:800}
    .toast{position:fixed;right:12px;bottom:12px;background:#ffffff;border:1px solid var(--border);color:#111827;padding:10px 12px;border-radius:10px;display:none}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
    .modal>.dialog{width:min(560px,94vw);background:#ffffff;border:1px solid var(--border);border-radius:16px;padding:18px}
    .list{list-style:none;padding-left:16px;margin:8px 0}
    .list li{margin:6px 0;color:var(--ink)}
    @media (max-width:920px){.kv{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <!-- 顶部导航 -->
    <header class="panel nav">
      <div>
        <div style="font-weight:800">饭圈粉丝人格测评</div>
        <div class="muted" style="font-size:12px">科普/参考用途 · 非医疗诊断</div>
      </div>
      <nav>
        <a href="#features">功能</a>
        <a href="#how">原理</a>
        <a href="#idol">应援对象</a>
        <a href="#sample">示例</a>
        <a href="#pricing">升级</a>
        <a href="#faq">FAQ</a>
        <span style="opacity:.4">|</span>
        <a href="./terms.html">条款</a>
        <a href="./privacy.html">隐私</a>
      </nav>
    </header>

    <!-- 主视图（路由：home / test / result） -->
    <main id="view-home" class="kv" style="margin-top:14px">
      <section class="panel">
        <h1>5 分钟测出你的「饭圈人格」</h1>
        <p class="muted">选择你的应援对象，回答 16 题，即刻生成<strong>可分享的结果卡</strong>；可选择升级解锁完整 PDF 与 7 日练习清单。</p>
        <div class="row" style="margin:8px 0 6px">
          <span class="badge">本地计算</span>
          <span class="badge">结果卡可分享</span>
          <span class="badge">不收集答案</span>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="scrollToId('idol')">先选应援对象</button>
          <button class="btn ghost" onclick="startTest()">直接开始测评</button>
          <a class="btn ghost" href="./result.html?demo=1">查看示例结果</a>
        </div>
      </section>

      <aside class="panel sticky">
        <h2>你将获得</h2>
        <div class="grid grid-3" style="margin-top:10px">
          <div class="panel" style="padding:12px"><div style="font-weight:600">四维度得分</div><div class="muted" style="font-size:13px">应援投入 / 理智指数 / 社交扩散 / 内容考据</div></div>
          <div class="panel" style="padding:12px"><div style="font-weight:600">粉籍类型</div><div class="muted" style="font-size:13px">基于分布映射的 6 种粉籍档案</div></div>
          <div class="panel" style="padding:12px"><div style="font-weight:600">可分享结果卡</div><div class="muted" style="font-size:13px">一键生成分享图，含应援对象与分数</div></div>
        </div>
      </aside>
    </main>

    <!-- 功能区块 -->
    <section id="features" class="panel" style="margin-top:14px">
      <h2>适合谁？</h2>
      <div class="grid grid-3" style="margin-top:10px">
        <div class="panel" style="padding:12px"><b>粉圈新人</b><div class="muted" style="font-size:13px">了解你更偏向理智/应援/考据/扩散哪一面</div></div>
        <div class="panel" style="padding:12px"><b>老粉主理人</b><div class="muted" style="font-size:13px">识别团队分工，优化应援节奏</div></div>
        <div class="panel" style="padding:12px"><b>内容创作者</b><div class="muted" style="font-size:13px">找到更适配的选题与互动方式</div></div>
      </div>
    </section>

    <!-- 原理 -->
    <section id="how" class="panel" style="margin-top:14px">
      <h2>工作原理</h2>
      <div class="grid grid-3" style="margin-top:10px">
        <div class="panel" style="display:flex;gap:8px;align-items:flex-start"><div class="num">1</div><div><b>16 题 Likert</b><div class="muted" style="font-size:13px">1~5 分量表，本地计算四维度分数</div></div></div>
        <div class="panel" style="display:flex;gap:8px;align-items:flex-start"><div class="num">2</div><div><b>分布映射</b><div class="muted" style="font-size:13px">将分数映射到 6 种粉籍类型（示例）</div></div></div>
        <div class="panel" style="display:flex;gap:8px;align-items:flex-start"><div class="num">3</div><div><b>结果卡分享</b><div class="muted" style="font-size:13px">Canvas 生成图片，保存或社媒分享</div></div></div>
      </div>
    </section>

    <!-- 应援对象选择 -->
    <section id="idol" class="panel" style="margin-top:14px">
      <h2>选择你的应援对象（可选）</h2>
      <div class="muted" style="font-size:13px;margin-bottom:6px">用于结果卡展示，不影响打分；也可自定义输入。</div>
      <div id="idol-list" class="row"></div>
      <div style="margin-top:8px" class="row">
        <input id="idol-custom" placeholder="自定义应援对象（如：晨曦偶像·林X）" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:#ffffff;color:var(--ink)"/>
        <button class="btn ghost" onclick="saveCustomIdol()">使用自定义</button>
        <button class="btn" onclick="startTest()">选好了，开始测评</button>
      </div>
    </section>

    <!-- 测评视图 -->
    <section id="view-test" class="panel hidden" style="margin-top:14px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">测评进行中</h2>
        <div class="muted" style="font-size:12px">约 5 分钟 · 16 题</div>
      </div>
      <div class="bar" style="margin:10px 0 12px"><span id="prog" style="width:0%"></span></div>
      <div id="qwrap" class="panel" style="padding:16px"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn ghost" onclick="prevQ()">上一步</button>
        <button id="nextBtn" class="btn" onclick="nextQ()">下一步</button>
      </div>
    </section>

    <!-- 结果视图 -->
    <section id="view-result" class="hidden" style="margin-top:14px">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">你的结果</h2>
          <div class="muted" style="font-size:12px">应援对象：<span id="res-idol">未选择</span></div>
        </div>
        <div id="res-type" style="font-size:18px;font-weight:700;margin:8px 0">类型：</div>
        <div id="score-grid" class="grid grid-2" style="margin-top:8px"></div>
        <div class="row" style="margin-top:12px">
          <button class="btn" onclick="genShare()">生成分享图片</button>
          <button class="btn ghost" onclick="startTest(true)">重新测一次</button>
          <button class="btn ghost" onclick="scrollToId('pricing')">升级获取完整报告</button>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3 style="margin:0 0 8px">建议（概览）</h3>
        <ul id="res-tips" class="list"></ul>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3 style="margin:0 0 8px">分享图片预览</h3>
        <canvas id="share-canvas" width="900" height="1200" style="width:100%;border-radius:12px;border:1px solid var(--border)"></canvas>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="downloadShare()">下载图片</button>
          <a class="btn ghost" href="#" id="copyLink">复制结果链接</a>
        </div>
      </div>
    </section>

    <!-- 示例 -->
    <section id="sample" class="panel" style="margin-top:14px">
      <h2>结果示例</h2>
      <div class="grid grid-2" style="margin-top:8px">
        <div class="panel" style="padding:12px">
          <div style="font-weight:700">粉籍类型 · 「理智派·资料官」</div>
          <div class="muted" style="font-size:13px">理智指数与内容考据较高，擅长整理资料、维基与年表；应援投入偏稳健。</div>
        </div>
        <div class="panel" style="padding:12px">
          <div style="font-weight:700">粉籍类型 · 「扩散派·应援长」</div>
          <div class="muted" style="font-size:13px">社交扩散与应援投入较高，擅长组织拉票与传播；理智指数略低但热情充沛。</div>
        </div>
      </div>
    </section>

    <!-- 价格与升级 -->
    <section id="pricing" class="panel" style="margin-top:14px">
      <h2>升级专业版 · 完整报告</h2>
      <div class="grid grid-2" style="margin-top:10px">
        <div class="panel" style="padding:12px">
          <div style="font-weight:800">免费版</div>
          <ul class="muted list" style="font-size:13px">
            <li>四维度概览</li>
            <li>粉籍类型判定</li>
            <li>分享图片生成</li>
          </ul>
          <button class="btn" onclick="startTest()">开始测评</button>
        </div>
        <div class="panel" style="padding:12px;position:relative">
          <div style="position:absolute;right:12px;top:12px" class="badge">推荐</div>
          <div style="font-weight:800">专业版</div>
          <div class="price-tag">¥39</div>
          <ul class="muted list" style="font-size:13px">
            <li>详细解释与人群对比</li>
            <li>7 日练习清单与打卡</li>
            <li>可下载 PDF（隐水印）</li>
          </ul>
          <button class="btn" onclick="openPay()">升级解锁</button>
          <div class="muted" style="font-size:12px;margin-top:6px">升级即表示同意 <a href="./terms.html">条款</a> 与 <a href="./privacy.html">隐私政策</a>。</div>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section id="faq" class="panel" style="margin-top:14px">
      <h2>常见问题</h2>
      <div class="grid grid-2" style="margin-top:8px">
        <div class="panel" style="padding:12px"><b>会保存我的答案吗？</b><div class="muted" style="font-size:13px">不会。答案仅在本地计算；如购买，仅处理订单必要信息。</div></div>
        <div class="panel" style="padding:12px"><b>未成年人可以使用吗？</b><div class="muted" style="font-size:13px">建议在监护指导下使用；本产品仅作科普参考。</div></div>
        <div class="panel" style="padding:12px"><b>可以退款吗？</b><div class="muted" style="font-size:13px">数字商品发放后一般不支持无理由退款；异常支付可人工处理。</div></div>
        <div class="panel" style="padding:12px"><b>是否官方/经纪公司授权？</b><div class="muted" style="font-size:13px">本测评为第三方科普工具，与任何官方或经纪公司无关。</div></div>
      </div>
    </section>

    <footer class="footer">© 2025 饭圈粉丝人格测评 · 科普/参考用途 · <a href="./privacy.html">隐私政策</a></footer>
  </div>

  <!-- 支付弹窗（占位，支持先演示后接入） -->
  <div id="pay-modal" class="modal"><div class="dialog">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">升级 · 完整报告 ¥39</div>
      <button class="btn ghost" onclick="closePay()">关闭</button>
    </div>
    <ol class="list" style="margin-top:8px">
      <li>方式 A：演示模式（假支付）— 直接跳“感谢页”并下载示例 PDF。</li>
      <li>方式 B：真实支付 — 连接你已有的 <code>/api/stripe_checkout</code> 或国内聚合接口。</li>
    </ol>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="fakePay()">演示一下</button>
      <button class="btn ghost" onclick="realPay()">走真实支付</button>
    </div>
  </div></div>

  <div id="toast" class="toast"></div>

  <script>
  // ============= 基础数据 ============= //
  const IDOLS = [
    '流火少年·主唱', '星光女团·队长', '极光组合·Rapper', '晨曦偶像·舞担', '薄荷男团·门面', '绮梦女团·Vocal', '赤潮少年·舞担', '云海少年·副主唱', '青柠女团·中心', '银河偶像·All-round'
  ];
  const QUESTIONS = [
    {id:'q1',  text:'我愿意为应援投入时间与精力（剪辑、拉票、打投等）。', dim:'effort'},
    {id:'q2',  text:'支持爱豆时我能保持理性，不盲目跟风。', dim:'rational'},
    {id:'q3',  text:'我喜欢在社交平台主动安利与分享。', dim:'social'},
    {id:'q4',  text:'我会考据行程、舞台、物料等细节并做整理。', dim:'lore'},
    {id:'q5',  text:'遇到负面舆论，我会组织或参与正向澄清。', dim:'effort'},
    {id:'q6',  text:'我能分清作品与私生活，不情绪化。', dim:'rational'},
    {id:'q7',  text:'我愿意和其他粉丝互关互助，扩大圈层影响。', dim:'social'},
    {id:'q8',  text:'我喜欢做年表/图鉴/资料库一类的内容。', dim:'lore'},
    {id:'q9',  text:'到关键节点（回归/打歌/生日）我会主动组织事项。', dim:'effort'},
    {id:'q10', text:'冲突时我能克制与他人的争执。', dim:'rational'},
    {id:'q11', text:'我熟悉各个平台的扩散机制并会应用。', dim:'social'},
    {id:'q12', text:'我对舞台细节/编曲/服化道等有耐心做对比研究。', dim:'lore'},
    {id:'q13', text:'我能协调资源（海报、后期、物料）推动应援。', dim:'effort'},
    {id:'q14', text:'我会关注经纪约束与版权合规，不发布违规内容。', dim:'rational'},
    {id:'q15', text:'我乐于写长文或做长视频安利。', dim:'social'},
    {id:'q16', text:'我喜欢做“时间线/术语表/传记式”整理。', dim:'lore'}
  ];

  // ============= 状态与工具 ============= //
  let state = { idol:null, idx:0, answers:{}, scores:null, type:null };
  const $ = sel => document.querySelector(sel);
  const toast = msg => { const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000) };
  const scrollToId = id => { document.getElementById(id)?.scrollIntoView({behavior:'smooth'}) };

  // Idol pills
  function renderIdols(){
    const wrap = document.getElementById('idol-list');
    wrap.innerHTML='';
    IDOLS.forEach(name=>{
      const b=document.createElement('button');
      b.textContent=name; b.className='pill';
      if(state.idol===name) b.classList.add('active');
      b.onclick=()=>{ state.idol=name; renderIdols(); toast('已选择：'+name) };
      wrap.appendChild(b);
    });
  }
  function saveCustomIdol(){
    const v = document.getElementById('idol-custom').value.trim();
    if(v){ state.idol=v; renderIdols(); toast('已使用自定义应援对象'); }
  }

  // Start test
  function startTest(reset){
    if(reset){ state={idol:state.idol, idx:0, answers:{}, scores:null, type:null}; }
    document.getElementById('view-home').classList.add('hidden');
    document.getElementById('view-test').classList.remove('hidden');
    renderQ();
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function renderQ(){
    const q = QUESTIONS[state.idx];
    $('#prog').style.width = ((state.idx)/QUESTIONS.length*100)+'%';
    const v = state.answers[q.id]||0;
    $('#qwrap').innerHTML = `
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px">第 ${state.idx+1} / ${QUESTIONS.length} 题</div>
      <div style="font-size:18px;font-weight:700;margin-bottom:12px">${q.text}</div>
      ${[1,2,3,4,5].map(n=>`<label style='display:block;margin:8px 0'>
        <input type='radio' name='ans' value='${n}' ${v===n?'checked':''}/> ${['非常不同意','不同意','一般','同意','非常同意'][n-1]}
      </label>`).join('')}
    `;
    document.querySelectorAll('input[name=ans]').forEach(r=>r.addEventListener('change',e=>{ state.answers[q.id]=parseInt(e.target.value)}));
    $('#nextBtn').textContent = state.idx===QUESTIONS.length-1 ? '完成并查看结果' : '下一步';
  }
  function nextQ(){
    const q = QUESTIONS[state.idx];
    if(!state.answers[q.id]){ toast('请选择一个选项'); return; }
    if(state.idx<QUESTIONS.length-1){ state.idx++; renderQ(); }
    else{ compute(); }
  }
  function prevQ(){ if(state.idx>0){ state.idx--; renderQ(); } }

  // Compute scores
  function compute(){
    const dims = {effort:0,rational:0,social:0,lore:0};
    const cnt = {effort:0,rational:0,social:0,lore:0};
    QUESTIONS.forEach(q=>{ dims[q.dim]+= (state.answers[q.id]||0); cnt[q.dim]++; });
    const scores = Object.fromEntries(Object.entries(dims).map(([k,v])=>[k, Math.round(v/(cnt[k]*5)*100)]));
    state.scores=scores;
    // Map to type
    const arr = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
    const top = arr[0][0];
    const TYPEMAP = {
      effort:'扩散派·应援长', rational:'理智派·资料官', social:'社交派·安利手', lore:'考据派·档案师'
    };
    state.type = TYPEMAP[top]||'平衡派·全能粉';
    renderResult();
  }

  function renderResult(){
    $('#view-test').classList.add('hidden');
    $('#view-result').classList.remove('hidden');
    $('#res-idol').textContent = state.idol || '（未选择）';
    $('#res-type').textContent = '类型：' + state.type;
    const grid = document.getElementById('score-grid'); grid.innerHTML='';
    const label = {effort:'应援投入', rational:'理智指数', social:'社交扩散', lore:'内容考据'};
    Object.entries(state.scores).forEach(([k,v])=>{
      const card=document.createElement('div'); card.className='panel'; card.style.padding='12px';
      card.innerHTML=`<div style='font-size:13px;color:var(--muted)'>${label[k]}</div>
        <div style='display:flex;align-items:center;gap:10px'><div class='bar' style='flex:1'><span style='width:${v}%'></span></div><div style='font-weight:800'>${v}</div></div>`;
      grid.appendChild(card);
    });
    // tips
    const tips = [];
    if(state.scores.effort>=70) tips.push('你拥有很强的组织与执行力，适合担任拉票/统筹角色。');
    if(state.scores.rational>=70) tips.push('你能保持克制与边界感，可担任资料官/规则解读。');
    if(state.scores.social>=70) tips.push('你的社交扩散力强，适合做安利、话题引导与话术。');
    if(state.scores.lore>=70) tips.push('你具备优秀的考据能力，适合做年表/舞台对比/资料库。');
    if(tips.length===0) tips.push('你的四维较为平衡，可根据兴趣选择一个方向深入。');
    const ul = document.getElementById('res-tips'); ul.innerHTML = tips.map(t=>`<li>${t}</li>`).join('');

    // copy link
    const link = location.origin + location.pathname + `?share=1&idol=${encodeURIComponent(state.idol||'')}&scores=${btoa(JSON.stringify(state.scores))}`;
    const copyBtn = document.getElementById('copyLink');
    copyBtn.onclick=(e)=>{ e.preventDefault(); navigator.clipboard.writeText(link).then(()=>toast('链接已复制')).catch(()=>{ prompt('复制此链接：', link); }); };
  }

  // Share image
  async function genShare(){
    if(!state.scores){ toast('请先完成测评再生成图片'); return; }
    try{ if(document.fonts && document.fonts.ready){ await document.fonts.ready; } }catch(e){}
    const cvs = document.getElementById('share-canvas');
    const ctx = cvs.getContext('2d');
    const W=cvs.width, H=cvs.height; ctx.clearRect(0,0,W,H);
    const css = getComputedStyle(document.documentElement);
    const BG1 = (css.getPropertyValue('--share-bg1')||'#ffffff').trim();
    const BG2 = (css.getPropertyValue('--share-bg2')||'#f5f7fb').trim();
    const INK = (css.getPropertyValue('--ink')||'#111827').trim();
    const MUTED = (css.getPropertyValue('--muted')||'#6b7280').trim();
    const PRI = (css.getPropertyValue('--pri')||'#6366f1').trim();
    // 背景
    const g=ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,BG1); g.addColorStop(1,BG2); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    // 标题
    ctx.fillStyle=INK; ctx.font='bold 48px Inter,system-ui'; ctx.fillText('饭圈人格测评', 48, 96);
    ctx.font='24px Inter,system-ui'; ctx.fillStyle=MUTED; ctx.fillText('粉籍类型：'+(state.type||''), 48, 140);
    // 应援对象
    const idol = state.idol||'我的爱豆';
    ctx.fillStyle='rgba(17,24,39,.06)'; roundRect(ctx, 48, 168, 420, 44, 12, true, false);
    ctx.fillStyle=INK; ctx.font='18px Inter,system-ui'; ctx.fillText('应援对象：'+idol, 64, 196);
    // 进度条
    const label = [['应援投入','effort'],['理智指数','rational'],['社交扩散','social'],['内容考据','lore']];
    let y=260; const barW=560, barH=18;
    label.forEach(([name,key])=>{
      const v=state.scores?.[key]||0;
      ctx.fillStyle=MUTED; ctx.font='18px Inter,system-ui'; ctx.fillText(name, 48, y);
      roundRect(ctx, 48, y+16, barW, barH, 9, false, true);
      ctx.fillStyle=PRI; roundRect(ctx, 48, y+16, Math.max(0, Math.min(barW*v/100, barW)), barH, 9, true, false);
      ctx.fillStyle=INK; ctx.font='bold 18px Inter,system-ui'; ctx.fillText(String(v), 48+barW+12, y+31);
      y+=72;
    });
    // 尾注
    ctx.fillStyle=MUTED; ctx.font='16px Inter,system-ui'; ctx.fillText('科普/参考 · 非医疗诊断 · '+new Date().toLocaleDateString(), 48, H-64);
    ctx.fillStyle=INK; ctx.font='16px Inter,system-ui'; ctx.fillText(location.host, 48, H-36);
    toast('分享图片已生成，可点击“下载图片”');
  }
  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    if (w<2*r) r=w/2; if (h<2*r) r=h/2; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if (fill) ctx.fill(); if (stroke) { ctx.strokeStyle='rgba(17,24,39,.12)'; ctx.stroke(); }
  }
  function downloadShare(){
    const url = document.getElementById('share-canvas').toDataURL('image/png');
    const a = document.createElement('a'); a.href=url; a.download='fan-profile.png'; a.click();
  }

  // Pay modal
  function openPay(){ document.getElementById('pay-modal').style.display='flex'; }
  function closePay(){ document.getElementById('pay-modal').style.display='none'; }
  function fakePay(){ closePay(); location.href='./checkout.html?dl=./assets/sample.pdf'; }
  function realPay(){ closePay(); try{ fetch('./api/stripe_checkout',{method:'POST'}).then(r=>r.json()).then(j=>{ if(j.url) location.href=j.url; else if(j.redirect) location.href=j.redirect; else toast('支付接口未配置'); }); }catch(e){ toast('支付接口未配置'); } }

  // Init
  renderIdols();
  // 解析分享链接（可选）
  const usp = new URLSearchParams(location.search);
  if(usp.get('share')){
    try{ state.idol = usp.get('idol')||null; state.scores = JSON.parse(atob(usp.get('scores')||'')); state.type='分享查看'; document.getElementById('view-home').classList.add('hidden'); document.getElementById('view-result').classList.remove('hidden'); renderResult(); }catch(e){/* ignore */}
  }
  </script>
</body>
</html>
